name: PushBranchWorkflow

on:
  push:
    branches:
    - '!documentation/**'
    - '*'

env:
  AWS_REGION: us-east-1
  S3_BUCKET: ${{ secrets.SuperSecret }}

jobs:
  confirm-prerequisites:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: nelonoel/branch-name@v1
    - uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${env.AWS_REGION}

    - name: Confirm prerequisites are in place to deploy
      run: |
        echo "Checking prerequisties are in place to deploy branch: ${BRANCH_NAME}"
        aws --version
        aws iam get-user
        ./.github/scripts/wait_for_param.sh ${BRANCH_NAME}
        echo "Update the app for ${BRANCH_NAME} here..."

  deploy:
    # The type of runner that the job will run on
    needs: confirm-prerequisites
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    - uses: actions/checkout@v2
    - uses: nelonoel/branch-name@v1
    - uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Deploy the application
      run: |
        echo "Running on branch push, branch: ${BRANCH_NAME}"
        aws --version
        aws iam get-user
        echo "Update the app for ${BRANCH_NAME} here..."
        aws s3 cp app/index.html s3://${BRANCH_NAME}.branchexample.flexion.us/index.html
